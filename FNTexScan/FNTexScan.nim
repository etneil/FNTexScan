import arraymancer
import FNTexture
import std/algorithm

proc count_below*(scores: seq[float], target_score: float = 5.0): int =
    result = 0
    for s in scores:
        if s <= target_score:
            result += 1


when isMainModule:
    import FNTheory, FNCost, random, tables
    import suru
    const max_Q = 4

    #[
    var allXQ: seq[array[3,int]] = @[]
    var allXu: seq[array[3,int]] = @[]
    var allXd: seq[array[3,int]] = @[]

    for a in -max_Q .. max_Q:
        for b in -max_Q .. max_Q:
           allXQ.add([a, b, 0])
           allXu.add([a, b, 0])
           for c in -max_Q .. max_Q:
               allXd.add [a, b, c]

    var all_textures: seq[FNTexture] = @[]
    var trialTex: FNTexture

    for XQ in allXQ:
        for Xu in allXu:
            for Xd in allXd:
                trialTex = initFNTexture(XQ=XQ, Xu=Xu, Xd=Xd)
                if trialTex.isValid: #and XQ[0] == 1:
                    all_textures.add trialTex
    ]#

    var all_textures = getAllValidTextures(max_Q)

    echo len(all_textures)

    const scan_all = false
    const SM_scan = true
    const simple_tex_file = false
    var texture_file: string

    if scan_all:
        texture_file = "good_textures.txt"
    elif SM_scan:
        texture_file = "SM_scan_textures.txt"
    else:
        texture_file = "top_textures.txt"

    let f = open(texture_file, fmWrite)


    # const found_good_tex = @[403]
    #[
    const found_good_tex = @[7965, 7969, 7981, 8013, 8025, 8201, 8580, 8581, 
                            8624, 8625, 8629, 8641, 8668, 8669, 8673, 8685, 8801,   
                            8805, 8817, 8861, 9284, 9285, 9289, 9328, 9329, 9333]
    ]#

    # Max Q=4 OLD no |J|
    #[
    const found_good_tex = @[236925, 307806, 308001, 308026, 309327, 309328, 309359, 
    309360, 309366, 309586, 310725, 310731, 310756, 310926, 310951, 312121, 316096, 316097, 
    316104, 316144, 316291, 316292, 316299, 316300, 316307, 316339, 316340, 316347, 316379, 
    316494, 316495, 316502, 316534, 316535, 316542, 316574, 317704, 317859, 317860, 317867, 
    317899, 317900, 317901, 317907, 317908, 317939, 317940, 318055, 318062, 318094, 318095, 
    318096, 318102, 318103, 318134, 318135, 318329, 319265, 319266, 319272, 319273, 319304, 
    319305, 319460, 319461, 319467, 319468, 319499, 319500, 319506, 319531, 319694, 319695, 
    319701, 319726, 320670, 320676, 320701, 320896, 324675, 324676, 324677, 324684, 324870, 
    324871, 324872, 324879, 324880, 324919, 324920, 325065, 325066, 325067, 325074, 325075, 
    325082, 325114, 325115, 325122, 325269, 325270, 325309, 325310, 325317, 326431, 326432, 
    326439, 326440, 326479, 326480, 326487, 326626, 326627, 326634, 326635, 326642, 326674, 
    326675, 326682, 326829, 326830, 326869, 326870, 326877, 328047, 342616, 342617, 342624, 
    342625, 342632, 342664, 342665, 342672, 342704, 342811, 342812, 342819, 342820, 342827, 
    342828, 342859, 342860, 342861, 342867, 342868, 342899, 343014, 343015, 343022, 343054, 
    343055, 343062, 343063, 343094, 344184, 344185, 344192, 344224, 344225, 344232, 344379, 
    344380, 344387, 344388, 344419, 344420, 344421, 344427, 344428, 344434, 344459, 344460, 
    344466, 344582, 344614, 344615, 344622, 344623, 344629, 344654, 344655, 344661, 345792, 
    345793, 345799, 345824, 345825, 345831, 345987, 345988, 346019, 346020, 346026, 351195, 
    351196, 351197, 351204, 351205, 351212, 351244, 351245, 351252, 351390, 351391, 351392, 
    351399, 351400, 351407, 351439, 351440, 351441, 351447, 351448, 351479, 351585, 351586, 
    351587, 351594, 351595, 351596, 351602, 351603, 351634, 351635, 351636, 351642, 351643, 
    351674, 351675, 351781, 351782, 351789, 351790, 351797, 351829, 351830, 351831, 351837, 
    351838, 351869, 351870, 352025, 352032, 352064, 352755, 352756, 352757, 352764, 352765, 
    352772, 352804, 352805, 352812, 352951, 352952, 352959, 352960, 352967, 352999, 353000, 
    353001, 353007, 353008, 353039, 353146, 353147, 353154, 353155, 353156, 353162, 353163, 
    353194, 353195, 353196, 353202, 353203, 353234, 353235, 353349, 353350, 353357, 353389, 
    353390, 353391, 353397, 353398, 353429, 353430, 353585, 353592, 353624, 354324, 354325, 
    354332, 354364, 354365, 354372, 354404, 354527, 354559, 354560, 354561, 354567, 354568, 
    354599, 354600, 354755, 354756, 354762, 354763, 354794, 354795, 354801, 355769, 355770, 
    359775, 359776, 359777, 359784, 359785, 359824, 359825, 359970, 359971, 359972, 359979, 
    359980, 359987, 360019, 360020, 360027, 360165, 360166, 360167, 360174, 360175, 360182, 
    360214, 360215, 360216, 360222, 360254, 360360, 360361, 360362, 360369, 360370, 360377, 
    360409, 360410, 360417, 360449, 360555, 360556, 360557, 360564, 360565, 360572, 360604, 
    360605, 360612, 360644, 360799, 360800, 361530, 361531, 361532, 361539, 361540, 361547, 
    361579, 361580, 361587, 361619, 361725, 361726, 361727, 361734, 361735, 361742, 361774, 
    361775, 361776, 361782, 361814, 361920, 361921, 361922, 361929, 361930, 361937, 361969, 
    361970, 361977, 362009, 362124, 362125, 362132, 362164, 362165, 362172, 362204, 363091, 
    363092, 363099, 363100, 363107, 363139, 363140, 363147, 363179, 363294, 363295, 363302, 
    363334, 363335, 363342, 363374, 363537, 363569, 368745, 368746, 368754, 368940, 368941, 
    368942, 368949, 368950, 368957, 368989, 368990, 368997, 369029, 369135, 369136, 369137, 
    369144, 369145, 369146, 369152, 369153, 369184, 369185, 369186, 369192, 369193, 369224, 
    369330, 369331, 369332, 369339, 369340, 369341, 369347, 369348, 369379, 369380, 369381, 
    369387, 369388, 369419, 369525, 369526, 369527, 369534, 369535, 369542, 369574, 369575, 
    369582, 369583, 369614, 370509, 370510, 370517, 370549, 370550, 370557, 370697, 370704, 
    370705, 370712, 370713, 370744, 370745, 370746, 370752, 370753, 370784, 370785, 370899, 
    370900, 370907, 370908, 370939, 370940, 370941, 370947, 370948, 370979, 371094, 371095, 
    371102, 371134, 371135, 371142, 371143, 371174, 372117, 377325, 377520, 377521, 377522, 
    377529, 377530, 377537, 377569, 377570, 377715, 377716, 377717, 377724, 377725, 377732, 
    377764, 377765, 377772, 377804, 377910, 377911, 377912, 377913, 377919, 377920, 377927, 
    377959, 377960, 377961, 377967, 377999, 378105, 378106, 378107, 378114, 378115, 378116, 
    378122, 378154, 378155, 378156, 378162, 378163, 378194, 378300, 378301, 378302, 378309, 
    378310, 378317, 378349, 378350, 378357, 378389, 379080, 379081, 379082, 379089, 379090,
    379129, 379130, 379275, 379276, 379277, 379284, 379285, 379292, 379324, 379325, 379332, 
    379364, 379470, 379471, 379472, 379479, 379480, 379481, 379487, 379488, 379519, 379520, 
    379521, 379527, 379528, 379559, 379560, 379665, 379666, 379667, 379674, 379675, 379676, 
    379682, 379714, 379715, 379716, 379722, 379723, 379754, 379861, 379862, 379869, 379870, 
    379877, 379909, 379910, 379917, 379949, 380649, 380650, 380657, 380689, 380690, 380697, 
    380729, 380845, 380852, 380885, 380892, 380924, 381080, 381087, 381275, 381282, 381314, 
    386295, 386296, 386304, 386490, 386491, 386492, 386499, 386500, 386507, 386539, 386540, 
    386547, 386685, 386686, 386687, 386694, 386695, 386702, 386734, 386735, 386736, 386742, 
    386880, 386881, 386882, 386889, 386890, 386897, 386929, 386930, 387075, 387076, 387077, 
    387084, 387085, 387092, 387124, 387125, 387132, 388059, 388060, 388100, 388246, 388247, 
    388254, 388255, 388262, 388295, 388644, 388645, 388652, 388685]

    ]#

    # Top 20 only, LOGNORMAL PRIOR, MATCHING TABLE 1
    
    const found_good_tex = @[158252, 84356, 157566, 26761, 32394, 
        12175, 55839, 70918, 88821, 123377, 
        113932, 132639, 160046, 161097, 69850,
        82981, 18964, 133675, 118142, 63043]
    


    # Max Q=4 NEW UPDATE 05/28/23, LOGNORMAL PRIOR

#    const found_good_tex = @[77, 143, 222, 315, 383, 533, 621, 766, 1183, 1373, 1545, 1609, 1657, 1793, 2695, 3437, 3822, 3870, 4189, 5224, 5936, 6304, 7042, 7175, 7377, 7910, 8214, 8416, 8494, 8610, 8666, 8718, 9148, 9424, 10345, 10485, 11189, 11299, 11413, 11621, 11692, 11740, 11866, 11901, 11975, 12002, 12175, 12213, 12580, 12634, 12684, 12796, 12987, 13131, 13414, 13456, 13934, 14341, 14459, 14545, 14701, 15249, 15654, 16111, 16560, 16653, 16831, 17002, 17215, 18062, 18167, 18298, 18402, 18464, 18732, 18964, 19080, 19204, 19216, 19473, 19527, 20150, 20364, 20826, 21051, 21123, 21398, 21566, 21628, 21745, 21775, 21931, 21935, 22161, 22305, 22317, 22384, 22482, 22550, 22727, 22763, 22883, 23360, 23426, 23463, 23613, 23784, 23812, 23876, 23916, 23956, 24184, 24435, 24639, 24908, 25501, 25649, 25884, 26064, 26546, 26761, 26856, 26888, 26928, 27011, 27131, 27378, 27436, 27572, 27736, 28720, 28789, 28970, 29070, 29238, 29302, 30072, 30188, 30357, 30513, 30757, 30880, 31083, 31195, 31468, 31745, 32099, 32394, 32476, 32608, 32710, 33139, 33342, 33348, 33588, 33644, 33724, 34486, 34546, 34619, 35231, 35339, 35577, 35900, 36003, 36033, 36231, 36362, 36519, 36616, 36788, 37111, 37123, 37494, 37612, 37807, 37855, 38119, 38259, 38369, 38604, 38660, 39100, 39287, 39362, 39638, 39895, 39940, 40157, 40202, 40222, 40390, 40951, 41644, 41846, 42420, 42569, 42729, 42867, 43020, 43332, 43338, 43419, 43522, 43587, 43731, 44144, 44225, 44273, 44380, 44736, 45576, 45655, 45754, 46128, 46571, 46583, 47277, 47364, 47585, 47631, 47802, 48333, 48417, 48637, 49446, 49680, 50286, 50670, 50714, 50754, 50862, 51535, 51826, 51911, 52025, 52117, 52577, 53111, 53891, 54030, 54036, 54135, 54564, 54691, 54980, 55165, 55177, 55422, 55484, 55496, 55545, 55627, 55839, 56027, 56091, 56303, 57164, 57240, 57907, 58126, 58368, 59040, 59100, 59285, 59408, 59812, 60130, 60164, 60196, 60503, 61265, 61874, 61896, 61916, 62501, 63043, 63281, 63661, 63979, 64564, 64633, 64639, 64695, 64752, 64820, 64828, 65042, 65482, 65976, 65988, 66588, 67282, 67294, 67320, 67328, 67372, 67738, 68007, 68215, 68599, 68951, 69204, 69426, 69432, 69612, 69618, 69850, 70162, 70397, 70485, 70750, 70814, 70918, 71174, 71250, 71394, 71476, 71590, 72008, 72252, 72676, 72873, 73025, 73212, 73462, 74175, 74211, 74277, 74472, 74600, 74656, 74843, 75142, 75998, 76574, 76726, 76937, 77042, 77142, 77336, 78199, 78688, 78868, 79045, 79105, 79672, 79859, 79904, 80095, 80652, 80658, 81190, 81261, 81433, 81604, 81751, 81801, 82257, 82881, 82977, 82981, 83059, 83161, 83197, 83290, 83294, 83429, 83557, 83721, 83785, 83905, 84356, 84557, 84846, 85097, 85703, 85861, 85933, 86000, 86678, 87211, 87251, 87367, 87443, 88202, 88357, 88593, 88771, 88821, 88977, 89071, 90017, 90410, 90721, 90777, 91055, 91317, 91844, 92387, 92475, 92531, 92733, 93014, 93073, 93547, 93553, 93617, 93911, 94013, 94092, 94533, 94541, 94605, 94645, 95135, 95191, 95263, 95340, 95539, 95840, 96452, 96635, 96778, 96784, 96883, 97682, 97903, 97939, 97966, 98207, 98323, 98391, 98547, 98935, 99140, 99368, 99606, 100110, 100244, 100399, 100513, 100858, 101003, 101091, 101154, 101714, 102470, 102969, 103097, 103186, 103240, 103308, 103435, 104068, 104375, 104381, 104824, 105138, 105504, 106334, 106693, 106880, 106926, 107614, 107754, 108002, 108038, 108074, 108396, 108404, 108494, 109032, 109153, 109745, 109979, 110200, 110625, 111215, 111756, 112226, 112262, 112298, 112379, 112768, 112925, 113054, 113085, 113836, 113932, 113956, 114095, 114115, 114570, 114828, 115078, 115172, 115435, 116283, 116475, 116929, 117033, 117057, 117133, 117452, 117802, 117912, 117938, 118084, 118142, 118338, 118494, 118522, 118560, 118666, 119029, 119283, 119491, 119495, 119610, 119889, 119907, 120074, 120501, 120749, 120977, 121189, 121275, 121403, 121753, 121819, 121895, 122008, 122184, 122339, 122415, 122427, 123120, 123377, 124286, 124544, 124690, 124724, 125037, 125217, 125229, 125374, 125912, 126002, 126231, 126495, 126515, 127081, 127316, 127375, 128521, 128753, 128870, 128943, 129480, 129538, 130171, 130189, 130458, 130998, 131969, 132197, 132397, 132639, 133097, 133675, 133919, 134247, 134337, 134425, 134756, 134936, 134983, 135279, 135415, 135502, 135508, 135577, 135597, 135897, 136136, 136572, 136764, 136891, 136975, 137185, 137259, 137618, 137662, 137734, 137822, 137986, 138040, 138150, 138156, 138304, 138443, 138455, 138789, 139332, 139456, 139651, 140109, 140226, 140282, 140524, 140758, 140882, 140914, 141426, 141513, 141677, 142400, 142836, 143184, 143192, 143234, 143733, 143757, 144301, 144529, 144706, 145283, 145568, 146874, 146878, 147188, 147713, 147976, 148116, 148274, 148400, 148758, 148959, 148975, 149019, 149378, 149458, 149474, 149868, 149944, 150169, 150371, 150567, 150946, 151036, 151691, 152910, 153190, 153557, 154053, 154109, 154160, 154312, 154443, 154597, 154770, 155047, 155151, 155371, 155445, 155539, 155753, 155789, 156040, 156559, 156625, 156835, 157350, 157566, 157605, 157659, 158220, 158252, 158535, 158874, 159598, 160046, 160414, 160697, 161097, 161357, 161457, 161864, 162036, 162310, 162450, 162703, 163099, 163680, 163986, 164289, 165003, 165766, 166118, 166190, 166980]

    # Max Q=4 NEW UPDATE 05/28/23, WIDE-LOGNORMAL PRIOR

    
#    const found_good_tex = @[77, 315, 383, 533, 748, 766, 1609, 1657, 1793, 3822, 3870, 4189, 4995, 5224, 5936, 7144, 7377, 7799, 7910, 8610, 8666, 8718, 9424, 11189, 11299, 11413, 11621, 11692, 11740, 11866, 11901, 12002, 12175, 12213, 12580, 12634, 12684, 12987, 13131, 13414, 13934, 14341, 14459, 14701, 14725, 14964, 15249, 15654, 15738, 16560, 16653, 16831, 17215, 18402, 18464, 18964, 19080, 19527, 20150, 20826, 21051, 21123, 21398, 21566, 21775, 21935, 22161, 22550, 22727, 22763, 22883, 23360, 23426, 23463, 23613, 23784, 23876, 23912, 23916, 24435, 24908, 25884, 26064, 26761, 26856, 26888, 26928, 27011, 27131, 27436, 27572, 27736, 28527, 28789, 29070, 29838, 30357, 30513, 30757, 30880, 31083, 31195, 31745, 32099, 32394, 32476, 32608, 32710, 33139, 33342, 33348, 33644, 33724, 34486, 34546, 34642, 35182, 35231, 35339, 35577, 35900, 36003, 36231, 36362, 36519, 36616, 37111, 37612, 37807, 38119, 38259, 38369, 38604, 38660, 38934, 39100, 39287, 39362, 39638, 39895, 39940, 40202, 40222, 40390, 42420, 42569, 42867, 43020, 43332, 43338, 43419, 43522, 43587, 44068, 44225, 44380, 45576, 45655, 46571, 47277, 47364, 47631, 48333, 48411, 48417, 48637, 49446, 49640, 50670, 50714, 51535, 52025, 52577, 53111, 54030, 54135, 54564, 55165, 55496, 55545, 55627, 55839, 56027, 56091, 56303, 57907, 58126, 58368, 59040, 59100, 59285, 59408, 60130, 60196, 60503, 61896, 61916, 62501, 63043, 63281, 64633, 64639, 64752, 64820, 64828, 65701, 65988, 66380, 66582, 66588, 67282, 67372, 67738, 68215, 68296, 68599, 69426, 69612, 69618, 69850, 70162, 70485, 70750, 70814, 70918, 71250, 71476, 71590, 72008, 72252, 73025, 73212, 74175, 74211, 74277, 74472, 74600, 74656, 75935, 76324, 76574, 77042, 77142, 78199, 78688, 79045, 79105, 79672, 79859, 79945, 80448, 80652, 80658, 81190, 81261, 81604, 81751, 82257, 82881, 82977, 82981, 83059, 83161, 83294, 83429, 83785, 83905, 84356, 84557, 85703, 85861, 86000, 86678, 87251, 87367, 88202, 88593, 88771, 88821, 89071, 90017, 90410, 90721, 90777, 91055, 91317, 92387, 92419, 92531, 92733, 93073, 93547, 93553, 93617, 94013, 94092, 94533, 94541, 94645, 95191, 95340, 95539, 95840, 96452, 96635, 96778, 96784, 96883, 97903, 97939, 98207, 98323, 98391, 98547, 98935, 99140, 100110, 100244, 100399, 101003, 101091, 101154, 101325, 101847, 102470, 102969, 103097, 103186, 103308, 104375, 104381, 104824, 105504, 106334, 106693, 106880, 106926, 107256, 107614, 107754, 108002, 108074, 108396, 108404, 108494, 109153, 109315, 109745, 109979, 110200, 111215, 111756, 112298, 112768, 112925, 113836, 113932, 113956, 114095, 114115, 114477, 114570, 114828, 115435, 115784, 117033, 117057, 117452, 117802, 117912, 118084, 118142, 118338, 118522, 118560, 118666, 119283, 119491, 119889, 119907, 120501, 120977, 121189, 121275, 121503, 121753, 121819, 121895, 122008, 122184, 122339, 123120, 123377, 124286, 124408, 124690, 124724, 125037, 125217, 125229, 125374, 126495, 126515, 127316, 128521, 128753, 128870, 128943, 129538, 130189, 130458, 130998, 132397, 132633, 132639, 133675, 133919, 134247, 134337, 134425, 134936, 135279, 135415, 136572, 137259, 137618, 137734, 137822, 138040, 138304, 138443, 139450, 139456, 140109, 140226, 141426, 141513, 142836, 143184, 143733, 143757, 144301, 144706, 145283, 145804, 146874, 146878, 147713, 147976, 148116, 148274, 148758, 148959, 149378, 149458, 149614, 149868, 150536, 150946, 151691, 153190, 154053, 154109, 154160, 154597, 155047, 155151, 155753, 155789, 156360, 156559, 156625, 157566, 157605, 157659, 158220, 158252, 158535, 158874, 160046, 160414, 161097, 161357, 161457, 161864, 162310, 162450, 162703, 163010, 163099, 163680, 163986, 164289, 165003, 166118, 166677, 166980]
    

    # Max Q=4 NEW UPDATE 05/29/23, WIDE LOGNORMAL PRIOR
    #[
    const found_good_tex = @[308026, 309359, 310724, 310725, 310731, 310756, 311926, 312121, 316299, 
    316300, 316339, 316340, 316347, 316535, 317899, 317900, 317907, 317939, 318095, 318102, 318134, 
    318135, 319272, 319304, 319499, 319500, 319506, 324675, 324870, 324871, 324872, 324879, 324919, 
    325066, 325074, 325075, 325114, 326439, 326440, 326479, 326675, 342421, 342429, 342469, 342616, 
    342617, 342624, 342625, 342632, 342664, 342665, 342672, 342704, 342811, 342819, 342820, 342827, 
    342859, 342860, 342867, 342899, 343055, 343062, 344029, 344184, 344185, 344192, 344224, 344225, 
    344232, 344264, 344379, 344380, 344387, 344419, 344420, 344421, 344427, 344428, 344459, 344460, 
    344466, 344622, 344623, 344654, 344655, 345597, 345629, 345792, 345824, 345825, 345831, 346019, 
    346020, 346026, 351000, 351001, 351009, 351195, 351196, 351197, 351204, 351205, 351244, 351245, 
    351390, 351391, 351392, 351399, 351400, 351407, 351439, 351440, 351447, 351479, 351585, 351586, 
    351587, 351594, 351595, 351602, 351634, 351635, 351636, 351642, 351674, 351789, 351790, 351797, 
    351829, 351830, 351837, 351869, 352755, 352756, 352764, 352765, 352772, 352804, 352805, 352812, 
    352951, 352952, 352959, 352960, 352967, 352999, 353000, 353001, 353007, 353039, 353154, 353155, 
    353162, 353194, 353195, 353196, 353202, 353203, 353234, 353235, 353390, 353397, 353429, 354332, 
    354364, 354365, 354372, 354404, 354560, 354567, 354568, 354599, 354600, 354762, 354794, 359775, 
    359776, 359777, 359784, 359970, 359971, 359972, 359979, 359980, 360019, 360165, 360166, 360167, 
    360174, 360175, 360182, 360214, 360215, 360222, 360360, 360361, 360362, 360369, 360370, 360377, 
    360409, 360410, 360417, 361530, 361531, 361532, 361539, 361540, 361579, 361725, 361726, 361727, 
    361734, 361735, 361742, 361774, 361775, 361782, 361929, 361930, 361969, 361970, 361977, 363100, 
    363147, 368550, 368551, 368745, 368746, 368747, 368754, 368755, 368794, 368795, 368940, 368941, 
    368942, 368949, 368950, 368957, 368989, 368990, 368997, 369029, 369135, 369136, 369137, 369144, 
    369145, 369146, 369152, 369153, 369184, 369185, 369186, 369192, 369193, 369224, 369331, 369332, 
    369339, 369340, 369347, 369379, 369380, 369387, 369388, 369419, 370306, 370314, 370315, 370354, 
    370355, 370362, 370502, 370509, 370510, 370517, 370549, 370550, 370557, 370589, 370704, 370705, 
    370712, 370744, 370745, 370746, 370752, 370753, 370784, 370900, 370907, 370939, 370940, 370941, 
    370947, 370948, 370979, 377325, 377326, 377334, 377374, 377520, 377521, 377522, 377529, 377530, 
    377569, 377570, 377715, 377716, 377717, 377724, 377725, 377732, 377764, 377765, 377772, 377910, 
    377911, 377912, 377919, 377920, 377921, 377927, 377959, 377960, 377961, 377967, 377999, 378105, 
    378106, 378107, 378114, 378115, 378122, 378154, 378155, 378162, 378194, 378350, 379080, 379081, 
    379082, 379089, 379090, 379129, 379130, 379275, 379276, 379277, 379284, 379285, 379292, 379324, 
    379325, 379332, 379471, 379472, 379479, 379480, 379487, 379519, 379520, 379527, 379559, 379675, 
    379682, 379714, 379715, 379722, 386100, 386101, 386109, 386295, 386296, 386297, 386304, 386305, 
    386344, 386490, 386491, 386492, 386499, 386500, 386507, 386539, 386540, 386547, 386685, 386686, 
    386687, 386694, 386695, 386702, 386734, 386735, 386736, 386742, 386880, 386881, 386882, 386889, 
    386890, 386897, 386929, 386930, 386937, 387085, 387124, 387856, 387864, 387904, 388051, 388052, 
    388059, 388060, 388099, 388100, 388254, 388255, 388262, 388294, 388295, 388490]
    ]#

    # Max Q=4 NEW UPDATE 05/27/23, UNIFORM PRIOR
    #[
    const found_good_tex = @[307806, 309327, 309359, 309360, 310724, 310725, 310731, 310756, 316096, 
    316097, 316104, 316105, 316144, 316145, 316291, 316292, 316299, 316300, 316307, 316339, 316340, 
    316347, 316379, 316534, 316535, 316542, 316574, 317656, 317657, 317664, 317665, 317704, 317705, 
    317852, 317859, 317860, 317867, 317899, 317900, 317907, 317939, 318094, 318095, 318102, 318134,
    318135, 319265, 319272, 319304, 319467, 319499, 319500, 324675, 324676, 324684, 324870, 324871,
    324872, 324879, 324880, 324919, 325065, 325066, 325067, 325074, 325075, 325114, 325115, 326431,
    326439, 326440, 326634, 326635, 326674, 326675, 342420, 342421, 342429, 342615, 342616, 342617, 
    342624, 342625, 342632, 342664, 342665, 342672, 342704, 342811, 342812, 342819, 342820, 342827, 
    342859, 342860, 342867, 342899, 343062, 344184, 344185, 344192, 344224, 344225, 344232, 344264, 
    344379, 344380, 344387, 344419, 344420, 344427, 344428, 344459, 344460, 344622, 344654, 345792, 
    345824, 345825, 351000, 351001, 351195, 351196, 351197, 351204, 351205, 351244, 351245, 351390, 
    351391, 351392, 351399, 351400, 351407, 351439, 351440, 351447, 351479, 351585, 351586, 351587, 
    351594, 351595, 351602, 351634, 351635, 351642, 351674, 351829, 351830, 351837, 351869, 352755, 
    352756, 352757, 352764, 352765, 352804, 352805, 352950, 352951, 352952, 352959, 352960, 352967, 
    352999, 353000, 353007, 353039, 353146, 353147, 353154, 353155, 353162, 353194, 353195, 353202, 
    353234, 353389, 353390, 353397, 354365, 354372, 354567, 359775, 359776, 359784, 359824, 359970, 
    359971, 359972, 359979, 359980, 360019, 360165, 360166, 360167, 360174, 360175, 360214, 360215, 
    360360, 360361, 360362, 360369, 360370, 360409, 361530, 361531, 361532, 361539, 361540, 361579, 
    361725, 361726, 361727, 361734, 361735, 361774, 368745, 368746, 368754, 368940, 368941, 368942, 
    368949, 368950, 368957, 368989, 368990, 369135, 369136, 369137, 369144, 369145, 369152, 369184, 
    369185, 369192, 369331, 369339, 369340, 369379, 369380, 370509, 370510, 370549, 370550, 370704, 
    370705, 370712, 370744, 370745, 370752, 370940, 377325, 377326, 377520, 377521, 377522, 377529, 
    377569, 377715, 377716, 377717, 377724, 377725, 377764, 377765, 377910, 377911, 377912, 377919, 
    377920, 377959, 377960, 378105, 378106, 378114, 378115, 378154, 379080, 379081, 379089, 379275, 
    379276, 379277, 379284, 379285, 379324, 379325, 379471, 379472, 379479, 379480, 379519, 379520, 
    386295, 386296, 386490, 386491, 386492, 386499, 386539, 386685, 386686, 386687, 386694]
    ]#

    # Top 20 only (LOG-NORMAL PRIOR)

    #[
    const found_good_tex = @[351439, 351399, 353202, 351634, 377724, 351635, 360174,
     353234, 351440, 353195, 377919, 318134, 377716, 377764, 377959, 360166, 360214,
     351400, 351642, 351594]
    ]#

    # Top 20 only (LOG-NORMAL PRIOR, FIXED TABLE 1 ORDERING)
    #[
    const found_good_tex = @[351439, 351399, 353202, 351634, 377724, 351635, 360174,
     353234, 351440, 353195, 318134, 377919, 377716, 377764, 351400, 377959, 360166,
     360214, 351594, 351642]
    ]#

    # Top 50 (LOG-NORMAL UPDATED)

    #[
    const found_good_tex = @[351439, 351399, 353202, 351634, 353234, 377724, 360174, 351635,
     377919, 351440, 377716, 318134, 377959, 353195, 360214, 377764, 360166, 351400, 360409,
     351642]
    ]#

    # Max Q=4 (WIDE PRIOR)
    #[
    const found_good_tex = @[308026, 309327, 309359, 310724, 310725, 310731, 310756, 311926, 312121, 316104, 316299, 316300, 316307, 316339, 316340, 316347, 316534, 316542, 316574, 317704, 317867, 317899, 317900, 317907, 317939, 318094, 318095, 318102, 318134, 318135, 319272, 319304, 319305, 319467, 319499, 319500, 319506, 320676, 324675, 324870, 324871, 324879, 324919, 325065, 325066, 325074, 325075, 325114, 325115, 325309, 326439, 326440, 326479, 326634, 326674, 326675, 326682, 342420, 342421, 342429, 342469, 342615, 342616, 342617, 342624, 342625, 342632, 342664, 342665, 342672, 342704, 342811, 342819, 342820, 342827, 342859, 342860, 342867, 342899, 343062, 343094, 344029, 344184, 344185, 344192, 344224, 344225, 344232, 344264, 344379, 344380, 344387, 344419, 344420, 344427, 344428, 344434, 344459, 344460, 344466, 344615, 344622, 344623, 344654, 344655, 345597, 345629, 345792, 345824, 345825, 345831, 345987, 346019, 346020, 346026, 351000, 351001, 351195, 351196, 351197, 351204, 351205, 351212, 351244, 351245, 351252, 351390, 351391, 351392, 351399, 351400, 351407, 351439, 351440, 351447, 351479, 351585, 351586, 351587, 351594, 351595, 351602, 351634, 351635, 351636, 351642, 351674, 351789, 351790, 351797, 351829, 351830, 351837, 351869, 352755, 352756, 352757, 352764, 352765, 352772, 352804, 352805, 352812, 352950, 352951, 352959, 352960, 352967, 352999, 353000, 353001, 353007, 353008, 353039, 353154, 353155, 353162, 353194, 353195, 353196, 353202, 353203, 353234, 353235, 353357, 353389, 353390, 353397, 353398, 353429, 353430, 354364, 354365, 354372, 354373, 354404, 354560, 354567, 354568, 354599, 354600, 354762, 354794, 354795, 359775, 359776, 359777, 359784, 359824, 359970, 359971, 359972, 359979, 359980, 360019, 360020, 360165, 360166, 360167, 360174, 360175, 360182, 360214, 360215, 360222, 360360, 360361, 360362, 360369, 360370, 360377, 360409, 360410, 360417, 360449, 360564, 360604, 360605, 361530, 361531, 361532, 361539, 361540, 361547, 361579, 361580, 361587, 361725, 361726, 361727, 361734, 361735, 361742, 361774, 361775, 361782, 361814, 361921, 361929, 361930, 361937, 361969, 361970, 361977, 362009, 363099, 363100, 363139, 363140, 363147, 368550, 368551, 368559, 368745, 368746, 368747, 368754, 368755, 368762, 368794, 368795, 368940, 368941, 368942, 368949, 368950, 368957, 368989, 368990, 368991, 368997, 369029, 369135, 369136, 369137, 369144, 369145, 369152, 369184, 369185, 369186, 369192, 369193, 369224, 369330, 369331, 369332, 369339, 369340, 369347, 369379, 369380, 369387, 369419, 369575, 370306, 370314, 370315, 370322, 370354, 370355, 370500, 370501, 370502, 370509, 370510, 370517, 370549, 370550, 370557, 370589, 370696, 370704, 370705, 370712, 370713, 370744, 370745, 370746, 370752, 370753, 370784, 370785, 370899, 370900, 370907, 370939, 370940, 370941, 370947, 370948, 370979, 371174, 371915, 371954, 372117, 377325, 377326, 377327, 377334, 377374, 377520, 377521, 377522, 377529, 377530, 377569, 377570, 377715, 377716, 377717, 377724, 377725, 377726, 377732, 377764, 377765, 377772, 377804, 377910, 377911, 377912, 377919, 377920, 377921, 377927, 377959, 377960, 377961, 377967, 377999, 378105, 378106, 378107, 378114, 378115, 378122, 378154, 378155, 378156, 378162, 378194, 378309, 378349, 379080, 379081, 379082, 379089, 379090, 379097, 379129, 379130, 379275, 379276, 379277, 379284, 379285, 379292, 379324, 379325, 379332, 379364, 379471, 379472, 379479, 379480, 379481, 379487, 379519, 379520, 379521, 379527, 379528, 379559, 379674, 379675, 379682, 379714, 379715, 379722, 379754, 380650, 380689, 380690, 380697, 380885, 380892, 386100, 386101, 386109, 386295, 386296, 386297, 386304, 386305, 386344, 386490, 386491, 386492, 386499, 386500, 386507, 386539, 386540, 386547, 386685, 386686, 386687, 386694, 386695, 386702, 386734, 386735, 386736, 386742, 386880, 386881, 386882, 386889, 386890, 386897, 386929, 386930, 386937, 387084, 387085, 387092, 387124, 387125, 387855, 387856, 387864, 387865, 387904, 388051, 388052, 388059, 388060, 388099, 388100, 388246, 388247, 388254, 388255, 388262, 388294, 388295, 388302, 388449, 388450, 388457, 388489, 388490, 388497]
    ]#

    # Top 20 only (WIDE PRIOR)
    #[
    const found_good_tex = @[351439, 377764, 360174, 351399, 353202, 353234, 351400, 353195,
     377959, 351440, 360166, 360409, 368989, 377724, 318102, 351595, 351634, 353000, 360165,
     360175]
    ]#

    # Max Q=4 (UNIFORM PRIOR)
    # const found_good_tex = @[307800, 307806, 309132, 309327, 309359, 309360, 310724, 310725, 310731, 310756, 316096, 316097, 316104, 316105, 316144, 316145, 316291, 316292, 316299, 316300, 316307, 316339, 316340, 316347, 316379, 316534, 316535, 316542, 316574, 317656, 317657, 317664, 317665, 317704, 317705, 317851, 317852, 317859, 317860, 317867, 317899, 317900, 317907, 317939, 318094, 318095, 318102, 318134, 318135, 319265, 319272, 319304, 319460, 319467, 319499, 319500, 324675, 324676, 324684, 324870, 324871, 324872, 324879, 324880, 324919, 325065, 325066, 325067, 325074, 325075, 325114, 325115, 326431, 326439, 326440, 326634, 326635, 326674, 326675, 342420, 342421, 342429, 342615, 342616, 342617, 342624, 342625, 342632, 342664, 342665, 342672, 342704, 342811, 342812, 342819, 342820, 342827, 342859, 342860, 342867, 342899, 344184, 344185, 344192, 344224, 344225, 344232, 344264, 344379, 344380, 344387, 344419, 344420, 344427, 344459, 344460, 344622, 344654, 344655, 345792, 345824, 345825, 346020, 351000, 351001, 351009, 351195, 351196, 351197, 351204, 351205, 351244, 351245, 351390, 351391, 351392, 351399, 351400, 351407, 351439, 351440, 351447, 351479, 351585, 351586, 351587, 351594, 351595, 351602, 351634, 351635, 351642, 351674, 351829, 351830, 351837, 351869, 352755, 352756, 352757, 352764, 352765, 352772, 352804, 352805, 352812, 352950, 352951, 352952, 352959, 352960, 352967, 352999, 353000, 353007, 353039, 353146, 353147, 353154, 353155, 353162, 353194, 353195, 353202, 353234, 353390, 353397, 353429, 354364, 354365, 354372, 354404, 354559, 354560, 354567, 354599, 354794, 359775, 359776, 359784, 359824, 359970, 359971, 359972, 359979, 359980, 360019, 360020, 360165, 360166, 360167, 360174, 360175, 360214, 360215, 360360, 360361, 360362, 360369, 360370, 360409, 360410, 360417, 361530, 361531, 361532, 361539, 361540, 361579, 361580, 361725, 361726, 361727, 361734, 361735, 361774, 361775, 361921, 361929, 361930, 361969, 361970, 361977, 368745, 368746, 368754, 368940, 368941, 368942, 368949, 368950, 368957, 368989, 368990, 368997, 369135, 369136, 369137, 369144, 369145, 369152, 369184, 369185, 369192, 369331, 369339, 369340, 369379, 369380, 370509, 370510, 370549, 370550, 370557, 370704, 370705, 370712, 370744, 370745, 370752, 370900, 370940, 377325, 377326, 377334, 377520, 377521, 377522, 377529, 377569, 377715, 377716, 377717, 377724, 377725, 377764, 377765, 377910, 377911, 377912, 377919, 377920, 377959, 377960, 378105, 378106, 378107, 378114, 378115, 378154, 378155, 379080, 379081, 379089, 379129, 379275, 379276, 379277, 379284, 379285, 379324, 379325, 379470, 379471, 379472, 379479, 379480, 379519, 379520, 379674, 379675, 379714, 379715, 386295, 386296, 386304, 386490, 386491, 386492, 386499, 386539, 386685, 386686, 386687, 386694, 386734, 386882]

    # Top 20 only (UNIFORM PRIOR)
    #[
    const found_good_tex = @[351439, 351399, 352999, 377724, 377716, 353000, 351391, 351634,
     377715, 377764, 353202, 318134, 351440, 377520, 352959, 344427, 360174, 353195, 351204,
     360214]
    ]#
    

    var optThy: FNTheory
    var opt_eps: float
    var opt_score, opt_score_SM, nat_score_SM: float

    const thy_per_tex = 10000
    const good_threshold = 0.05
    var all_costs, all_eps, all_costs_SM, all_nat_SM: seq[float] = @[]
    var all_traces: seq[float] = @[]
    var num_good: int
    var frac_good: float
    var good_tex_indices: seq[int]

    var mix_report: array[8, float64]

    var goodTexCount5 = initOrderedTable[int, float]()
    var goodTeXCount2 = initOrderedTable[int, float]()
    var goodEps2 = initOrderedTable[int, float]()
    var goodTrace = initOrderedTable[int, float]()

    var scan_tex: seq[FNTexture] = @[]
    if scan_all:
        scan_tex = all_textures
    else:
        for i in found_good_tex:
            scan_tex.add all_textures[i]


    randomize()
    for i, tex in suru(scan_tex):
        all_costs = @[]
        all_costs_SM = @[]
        all_eps = @[]
        all_traces = @[]
        for k in 0 .. thy_per_tex:
#            optThy = makeRandomTheory(tex=tex, prior_type="uniform")
#            optThy = makeRandomTheory(tex=tex, prior_type="wide_lognormal")
            optThy = makeRandomTheory(tex=tex, prior_type="lognormal")

            try:
                opt_eps = optimize_eps(optThy, brute_force = false, max_exp = true)
            except Exception as e:
                opt_eps = optimize_eps(optThy, brute_force = true, max_exp = true)

            if SM_scan:
                optThy = optimize_SM(optThy)

            optThy.C[^1] = ln(opt_eps)

            all_eps.add opt_eps

            opt_score = optThy.scoreSMDeviations(max_exp = true)

            all_costs.add opt_score

            opt_score_SM = optThy.scoreSMDeviations(max_exp = false)

            all_costs_SM.add opt_score_SM            

            nat_score_SM = optThy.naturalness_cost(sigma_weight = 0.691)

            all_nat_SM.add nat_score_SM

            mix_report = optThy.reportMixing()

            all_traces.add (mix_report[0] + mix_report[1]) / 2.0

        num_good = count_below(all_costs, target_score=5.0)
        frac_good = (num_good / thy_per_tex).float

        if scan_all:
            if frac_good > good_threshold:
                good_tex_indices.add i
                f.writeLine(i)
        else:
            echo "Texture ", i, ": "
            echo tex.XQ
            echo tex.Xu
            echo tex.Xd
            var num_good_2 = count_below(all_costs, target_score=2.0)
            let frac_good_2 = num_good_2 / thy_per_tex
            echo frac_good_2, " ", frac_good

#            var num_good_SM = count_below(all_costs_SM, target_score=40.0)
#            let frac_good_SM = num_good_SM / thy_per_tex

            echo "SM fits (1 sigma): ", count_below(all_costs_SM, target_score=10.0)
            echo "SM fits (2 sigma): ", count_below(all_costs_SM, target_score=40.0)
            echo "SM fits (3 sigma): ", count_below(all_costs_SM, target_score=90.0)

            var tmp_eps = 0.0
            var tmp_trace = 0.0
            for i, s in all_costs:
                if s <= 2.0:
                    tmp_eps += all_eps[i]
                    tmp_trace += all_traces[i]

            goodTexCount5[i] = frac_good
            goodTexCount2[i] = frac_good_2
            goodEps2[i] = tmp_eps / float(num_good_2)
            goodTrace[i] = tmp_trace / float(num_good_2)
#            echo "Good within 5: ", frac_good
#            echo "Good within 2: ", num_good_2 / thy_per_tex

        
    if scan_all:
        echo good_tex_indices
    else:
        proc sortValues(x,y: (int, float)): int = cmp(x[1], y[1])
        proc sortAbs(x, y: int): int = cmp(abs(x), abs(y))

        if not simple_tex_file:
            goodTexCount5.sort(sortValues, order=SortOrder.Descending)
            goodTexCount2.sort(sortValues, order=SortOrder.Descending)

        # Print top 20 textures
        var i_top = 0

        for key, val in goodTexCount2:
            let tex_i = found_good_tex[key]
            var this_tex = all_textures[tex_i]

            if simple_tex_file:
#                var i_simple = i_top + 1
#                this_tex.XQ.sort(sortAbs, Descending)
#                this_tex.Xu.sort(sortAbs, Descending)
#                this_tex.Xd.sort(sortAbs, Descending)

#                f.writeLine(i_simple, " ", this_tex.XQ, " ", this_tex.Xu, " ", this_tex.Xd)
                let XQ_str = $this_tex.XQ[0] & "," & $this_tex.XQ[1] & "," & $this_tex.XQ[2]
                let Xu_str = $this_tex.Xu[0] & "," & $this_tex.Xu[1] & "," & $this_tex.Xu[2]
                let Xd_str = $this_tex.Xd[0] & "," & $this_tex.Xd[1] & "," & $this_tex.Xd[2]

                f.writeLine(XQ_str, ",", Xu_str, ",", Xd_str)

            else:
                f.writeLine(tex_i, " ", this_tex.XQ, " ", this_tex.Xu, " ", this_tex.Xd, " ", val, " ", goodTexCount5[key], " ", goodEps2[key], " ", goodTrace[key])
            if i_top < 20:
                echo "Texture ", tex_i
                echo this_tex.XQ
                echo this_tex.Xu
                echo this_tex.Xd
                echo "Good within 2: ", val
                echo "Good within 5: ", goodTexCount5[key]
                echo "Mean eps: ", goodEps2[key]
                echo "Mean trace: ", goodTrace[key]

            i_top += 1

        # echo goodTexCount2

    f.close()






